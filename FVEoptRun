#!/bin/bash

source ~/.FVErc

function debugPrint() {
	if [ $VERB ]; then
		echo "$1"
	fi
}
function verbPrint() {
	if [ $DEBUG ]; then
		echo "$1"
	fi
}

function opt() {
	#usage opt $COMPONENT $EXPECTEDSTATUS
	local COMPONENT=$1
	local EXPECTEDSTATUS=${2,,}
	
	debugPrint "COMPONENT: EXPECTEDSTATUS"
	debugPrint "$COMPONENT: $EXPECTEDSTATUS"
	if [ "$EXPECTEDSTATUS" = "on" -o  "$EXPECTEDSTATUS" = "off" ]; then
		if [ "$EXPECTEDSTATUS" = "on" ]; then
			debugPrint "Turning on"
		elif [ "$EXPECTEDSTATUS" = "off" ]; then
			debugPrint "Turning off"
		fi
		if ( realStatus $COMPONENT $EXPECTEDSTATUS ); then
			FVEgenPage --update --$COMPONENT $EXPECTEDSTATUS
		fi
	else
		echo "Unknown parametr for function opt(): $@"
	fi
}

function getDeviceNumber() {
	#usage: getDeviceNumber $COMPONENT
	local COMPONENT=$1
	debugPrint "Getting device number for: $COMPONENT"
	DEVICENUM=$( grep -B1 $COMPONENT /etc/tellstick.conf | head -1 | awk '{print $NF}')
}

function realStatus(){
	#usage: getStatus $COMPONENT $STATUS
	local COMPONENT=$1
	local EXPECTEDSTATUS=$2
	local DEVICENUM=''
	getDeviceNumber $COMPONENT
	debugPrint "$COMPONENT has been found with device number $DEVICENUM"
	if [ -z $DEVICENUM ]; then
		debugPrint "Device not recognized, skipping"
		return 1
	fi
	local STATUS=$(tdtool -l | awk /$COMPONENT/'{print $NF}' | tr '[:upper:]' '[:lower:]' )
		if [ -z "$STATUS" ]; then
			verbPrint "Error in getting real status, skipping"
			return 1
		fi
		debugPrint "COMPONENT: DEVICENUM = EXPECTEDSTATUS:STATUS"
		debugPrint "$COMPONENT: $DEVICENUM = $EXPECTEDSTATUS:$STATUS"
	if [ "$STATUS" = "$EXPECTEDSTATUS" ]; then
		verbPrint "OK, nothing to change"
		return 0
	else
		debugPrint "changing status of device #$DEVICENUM from $STATUS to $EXPECTEDSTATUS"
		ERRMSG=$(tdtool --${EXPECTEDSTATUS,,} $DEVICENUM $VERBOUT )
		if [ "$?" != "0" ]; then
			echo "Problem with tdtool. Failed with message:"
			echo "\"$ERRMSG\""
		fi
	fi
}

function printHelp() {
	echo -e "\nusage: `basename $0` POWER OLDPOWER(s)
 Opts:
    POWER -- Current power production. Script then will issue requested steps
    OLDPOWER(s) -- Previous power production - up to 5
"
exit 0
}

function getAvrg() {
	#Will make average production in last 10 minutes (last 10 lines)
	AVRG=$(expr $(expr $(tail -10 $HISTORYFILE | awk '{print $2}' | sed '/^$/d' | sed ':a;N;$!ba;s/\n/ + /g')) / $(tail -10 $HISTORYFILE | awk '{print $2}' | sed '/^$/d' | wc -l) )	
}

function getMinVal() {
	CURMIN=$(expr $AVRG - $(expr $AVRG / 10))
}

function getMaxVal() {
	CURMAX=$(expr $AVRG + $(expr $AVRG / 10))
}

function getMinMax() {
	getAvrg
	debugPrint "Avrg is: $AVRG"
}

function checkParams() {
	if [ -z $DEVICE ] || [ -z $MINCOMP ] ; then 
		return 1
	fi
	if [ -z $MAXCOMP ]; then MAXCOMP=99999; fi
	
	debugPrint "Processing $DEVICE with params: $MINCOMP/$MAXCOMP"
	
	if [ $(echo $MINCOMP$MAXCOMP | sed 's/[0-9]*//g' ) ]; then 
		debugPrint "Detected non proper configuration for device $DEVICE: consumption: $MINCOMP/$MAXCOMP"
		return 1
	elif [ $MINCOMP -le 0 ] || [ $MAXCOMP -le 0 ]; then 
		debugPrint "Detected non proper configuration for device $DEVICE: consumption: $MINCOMP/$MAXCOMP"
		return 1
	fi
	if [ $MINCOMP -ge $MAXCOMP ]; then
		debugPrint "Minimal is bigger then maximal. This does not seems to be right: $MINCOMP/$MAXCOMP"
		return 1
	fi

	debugPrint "Params OK"
	return 0
}

VERBOUT="2>/dev/null"

if [ "$1" = '-h' -o "$1" = "--help" ]; then
	printHelp
	exit
elif [ "$1" = "-v" ]; then
	VERB=Y
	VERBOUT=''
	shift
elif [ "$1" = "--debug" ]; then
	VERB=Y
	VERBOUT=''
	DEBUG=Y
	shift
fi

getMinMax

cat $OPTCFGFILE | grep -v ^# | while read DEVICE MINCOMP MAXCOMP ; do
	if ( ! checkParams ); then
		continue
	fi
	
	if [ -z $MAXCOMP ]; then MAXCOMP=99999; fi
	
	debugPrint "Device $DEVICE with params $MINCOMP/$MAXCOMP passed tests"

	if [ $MINCOMP -le $AVRG  -a  $AVRG -le $MAXCOMP ]; then
		verbPrint "Production $AVRG is IN limits of device $DEVICE, turning on"
		opt $DEVICE ON
	else
		verbPrint "Production $AVRG is OFF limits of device $DEVICE, turning off"
		opt $DEVICE OFF
	fi
done

exit 0
