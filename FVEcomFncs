#!/bin/bash

function debugPrint() {
	echo "DEBUG: $1" >&2
}

function verbPrint() {
		echo "VERB:  $1"
}

function errorPrint() {
	echo "ERROR: $1"
}

# shellcheck disable=SC2145   # I know how fixed_"$@" behaves and it's correct!
calc(){ echo "scale=2;$@" | bc;}

function callHAAPI() {
	[ "$HAPORT" ] || HAPORT=8123
	debugPrint "curl -H \"Authorization: Bearer HAAPIKEY\" -H \"Content-Type: application/json\"  https://$HAURL:$HAPORT/api/states -o /tmp/HAAPI.json 2>/dev/null "
	curl -H "Authorization: Bearer $HAAPIKEY" -H "Content-Type: application/json"  https://"$HAURL":"$HAPORT"/api/states -o "$TMPDIR"/HAAPI.json 2>/dev/null 
	local exitval=$?
	debugPrint "Call ended with: $exitval"
	return $exitval
}

function parseHAAPI() {
	#Jakykoli vystup MUSI byt do &2, do stdout jde jen vysledek nakonci
	local HAENDPOINT="$1"
	local ARRTIBUTETOGET="$2"
	local RETVAL=''
	#RETVAL="$(jq --arg id "$HAENDPOINT" -c '.[] | select(.entity_id==$id )' "$TMPDIR"/HAAPI.json | jq -cj ".$ARRTIBUTETOGET" | tr ' ' '_'  )"
	#if [ "$( jq --arg id "$HAENDPOINT" -c '.[] | select(.entity_id==$id )' "$TMPDIR"/HAAPI.json  | jq -cj ".attributes.unit_of_measurement" )" = "kWh" ]; then
	#ENTITY="$(jq --arg id "$HAENDPOINT" -c '.[] | select(.entity_id==$id)' "$TMPDIR/HAAPI.json")"

	ENTITY="$( curl -H "Authorization: Bearer $HAAPIKEY" -H "Content-Type: application/json"  https://"$HAURL":"$HAPORT"/api/states/"$HAENDPOINT" 2>/dev/null )"
	RETVAL="$(echo "$ENTITY" | jq -cj ".$ARRTIBUTETOGET" | tr ' ' '_')"
	UNIT="$(echo "$ENTITY" | jq -cj '.attributes.unit_of_measurement')"
	if [ "$UNIT" = "kWh" ]; then
		debugPrint "Multiply by 1000 to convert kW to W"
		RETVAL="$(calc "$RETVAL"*1000)"
	fi
	debugPrint "For \"$HAENDPOINT\" attribute \"$ARRTIBUTETOGET\" is value: \"$RETVAL\""
	echo "$RETVAL"
}
