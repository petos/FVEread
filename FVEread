#!/bin/bash

source ~/.FVErc

function verbPrint() {
	if [ $VERB ]; then
		echo "`date +%d.%m.%Y-%H:%M`: $1"
	fi
}

function printHelp() {
	echo -e "usage: `basename $0` [OPTIONS]
 Opts:
  --help|-h   Print this help message
  -v          Talky version
  --stdout    Will not update webpage, but print just output to stdout
  --daemon|-d Enable auto-refresh, otherwise the script will issue only 
              one iteration.
  
  CAUTION: this are permanent changes and must be reverted via the oposite
           command!!!
  --disable   Kick off the script out of the crontab and stop all devices in cron
  --enable    Enable the script in cron
  --off       Turn off all devices and will disable power optimalization
  --on        Will enable power optimalization

  --mkbckp    Create backup and push to FTP
  --restorebckp
              Restore from backup
"
exit 0
}

function getAvrg() {
	#Will make average production in last 10 minutes (last 10 lines)
	AVRG=$(expr $(expr $(tail -10 $HISTORYFILE | awk '{print $2}' | sed '/^$/d' | sed ':a;N;$!ba;s/\n/ + /g')) / $(tail -10 $HISTORYFILE | awk '{print $2}' | sed '/^$/d' | wc -l) )	
	verbPrint "Avrg is: $AVRG"
}

function getFileFromFVE() {

	curl -u $FVEUSERNAME:$FVEPWD http://stridac > "$TMPDIR"/FVE.$$.html 2>/dev/null 
	if [ $? != 0 ]; then
		echo "Stridac neni dostupny"
		return 1
	else
		return 0
	fi
}

function cleanLine() {
	local LINE=$1
	echo $LINE | sed 's/<\/td>//g' | sed 's/&nbsp//g' | tr -d ' ' | \
	sed 's/xxx/0/g' | tr -dc '[:print:]'
}

function getCurrent() {
	local iCURRENT=`cat "$TMPDIR"/FVE.$$.html | grep -A2 'aktu[.]*'|grep ln -A2 | tail -1 `
	echo `cleanLine "$iCURRENT"`
}

function getToday() {
	local iTODAY=`cat "$TMPDIR"/FVE.$$.html | grep -A2 'denn[.]*'|grep energie -A2 | tail -1`
	echo `cleanLine "$iTODAY"`
}

function cleanFile() {
	rm -f "$TMPDIR"/FVE.$$.html
	#rm -f "$TMPDIR"/FVE.gn
	rm -f "$TMPDIR"/fved.png
	rm -f "$TMPDIR"/fvem.png
	rm -f "$TMPDIR"/fvep.png
	rm -f "$TMPDIR"/d`date +%Y%m%d`.png
	rm -f "$TMPDIR"/m`date +%Y%m`.png
	rm -f "$TMPDIR"/p`date +%Y%m`.png
	rm -f "$TMPDIR"/fve.device.*.png
	rm -f "$TMPDIR"/.fveread.lock
}

function checkRunningStatus() {
	if [ -e "$TMPDIR"/.fveread.lock ]; then
		echo "Already running, quiting."
		exit 0
	fi
	echo $$ > "$TMPDIR"/.fveread.lock
}


function updateProductionFile() {
	#usage: genProductionFiles 
	
	DATE=`date +%Y%m%d`

	sed -i /"$DATE"/d $PRODUCTIONFILE
	echo "$DATE $TODAY" >> $PRODUCTIONFILE
	
	return 0
}
 
function checkFileExist() {
	if [ ! -e $HTMLOPTFILE -o `cat $HTMLOPTFILE | wc -l` -le 1 ]; then
		FVEgenPage --optpage
	fi
	if [ ! -e $HTMLFILE ]; then
		FVEgenPage --defpage
	fi
}

function uploadDataFTP() {
	#usage: uploadDataFTP
	
	lftp -u "$FTPUSERNAME",$FTPPASSWD -e "mput -O "$HTMLDESTDIR" $TMPDIR/fvem.png $TMPDIR/fve.device.*.png $TMPDIR/fved.png /$TMPDIR/fvep.png $HTMLPOWERFILE $HTMLOPTFILE $HTMLFILE && bye" $HTMLSERVER >> /dev/null

	mv "$TMPDIR"/fved.png "$TMPDIR"/d`date +%Y%m%d`.png
	mv "$TMPDIR"/fvem.png "$TMPDIR"/m`date +%Y%m`.png
	mv "$TMPDIR"/fvep.png "$TMPDIR"/p`date +%Y%m`.png
	for FILE in "$TMPDIR"/fve.device.*.png; do 
		TRIMMED=${FILE%.png}
		mv $TRIMMED{.png,.`date +%Y%m%d`.png} 
	done


	return 0
}

function printDataStdout() {
	#usage: #printDataStdout 

	echo "My FV: `date`:"
	echo "Current production [kW]  = $CURRENT"
	echo "Avarage production [kW]  = $AVRG"
	echo "Today was produced [kWh] = $TODAY"
	return 0
}


function getData() {
	getFileFromFVE 
	if [ $? = 1 ]; then
		CURRENT="-0"
		TODAY="-0"
		FVESTATUS="Down/stopped"
	else
		CURRENT="`getCurrent`"
		TODAY="`getToday`"
		FVESTATUS="Running"
	fi
	getAvrg
}

function genFiles() {
	#usage: genFiles
		echo `date +%Y%m%d%H%M` $CURRENT $TODAY $AVRG >> "$HISTORYFILE"

		FVEgenPage  --powerpage --current $CURRENT --today $TODAY --fvestatus $FVESTATUS --avrg $AVRG
		
		updateProductionFile
		
		FVEgenGraphs --all
}

function disableMe() {
	crontab -l | sed  -e'/FVEread/s/^/#/g' | crontab	
}

function enableMe() {
	crontab -l | sed  -e'/FVEread/s/^#//g' | crontab
}

function onMe() {
        sed -i -e'/FVEOPTONOFF/s/"OFF"/"ON"/g' ~/.FVErc
}

function offMe() {
        sed -i -e'/FVEOPTONOFF/s/"ON"/"OFF"/g' ~/.FVErc
}

function mainLoop() {
	checkRunningStatus
	getData
	
	if [ "$STDOUT" ]; then
		printDataStdout 
	else
		genFiles
		checkFileExist
		FVEoptRun $VERBPARM
		uploadDataFTP
	fi
	cleanFile
}


function createBackup() {
	pushd "$FVEDATADIR" > /dev/null
	tar -czf "$TMPDIR"/fvedata.tar.gz *
	popd > /dev/null
	
	lftp -u "$FTPUSERNAME",$FTPPASSWD -e "put -O "$HTMLDESTDIR"/fve.hist/ "$TMPDIR"/fvedata.tar.gz && bye" $HTMLSERVER >> /dev/null
}

function restoreBackup() {
	pushd "$FVEDATADIR" > /dev/null
	wget http://"$HTMLSERVER"/"$HTMLDESTDIR"/fve.hist/fvedata.tar.gz
	tar -xzf "$TMPDIF"/fvedata.tar.gz 
	popd > /dev/null
	
	exit 0
}

VERBPARM=''
VERB=''


while [ $# -gt 0 ]; do
	case $1 in
		-h|--help) printHelp; exit; shift;;
		-d|--daemon) DAEMON=1; shift;;
		--stdout) STDOUT="YES" ; shift;;
		-v|--verbose) VERB=Y; VERBPARM="-v" ; shift;;
		--disable) 
			disableMe 2>/dev/null
			FVEoptRun --off
			shift
			exit
			;;
		--enable)
			enableMe 2>/dev/null
			shift
			;;
		--off)
			offMe
			shift
			;;
		--on)
			onMe
			shift
			;;
		--mkbckp)
			createBackup
			shift
			;;
		--restorebckp)
			restoreBackup
			shift
			;;
		*)  echo "$0: error - unrecognized option $1" 1>&2; exit 1;;
	esac
done

if [ $DAEMON ]; then
	while true; do
		while [ `date +%S` != "01" ]; do
			sleep 1
		done
		mainLoop
	done
else 
	mainLoop
fi
